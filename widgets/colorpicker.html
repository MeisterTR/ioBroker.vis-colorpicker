<!--
    ioBroker.vis bars Widget-Set

    version: "0.2.0"

    Copyright 2013-2016 hobbyquaker https://github.com/hobbyquaker, bluefox https://github.com/GermanBluefox
-->

<!--<script type="text/javascript" src="widgets/colorpicker/js/jscolor.js"></script>-->
<link rel="stylesheet" type="text/css" href="widgets/colorpicker/css/farbtastic.css" />
<link rel="stylesheet" type="text/css" href="widgets/colorpicker/css/spectrum.css" />

<script type="text/javascript" src="widgets/colorpicker/js/farbtastic.js"></script>
<script type="text/javascript" src="widgets/colorpicker/js/spectrum.js"></script>
<script type="text/javascript" src="widgets/colorpicker/js/jscolorCIE.js"></script>
<script type="text/javascript" src="widgets/colorpicker/js/huepiHelper.js"></script>

<script type="text/javascript">
    
    if (vis.language == 'de'){
        var localization = $.spectrum.localization.de = {
            cancelText: 			'Abbrechen',
            chooseText: 			'Wählen',
            clearText: 				'Farbauswahl zurücksetzen',
            noColorSelectedText: 	'Keine Farbe ausgewählt',
            togglePaletteMoreText: 	'Mehr',
            togglePaletteLessText: 	'Weniger'
        };
        $.extend($.fn.spectrum.defaults, localization);
    } else if (vis.language == 'ru'){
        var localization = $.spectrum.localization.ru = {
            cancelText: 			'отмена',
            chooseText: 			'выбрать',
            clearText: 				'сбросить',
            noColorSelectedText: 	'никакой цвет не выбран',
            togglePaletteMoreText: 	'больше',
            togglePaletteLessText: 	'меньше'
        };
        $.extend($.fn.spectrum.defaults, localization);
    }

    if (vis.editMode) {
        // Add words for basic widgets
        $.extend(true, systemDictionary, {
            "red-oid":              {"en": "Red ID",            "de": "Rot ID",             "ru": "Красный ID"},
            "green-oid":            {"en": "Green ID",          "de": "Grün ID",            "ru": "Зелёный ID"},
            "blue-oid":             {"en": "Blue ID",           "de": "Blau ID",            "ru": "Синий ID"},
            "divisor":              {"en": "divisor",           "de": "Divisor",            "ru": "Делитель"},
			"decimal": 		        {"en": "Precision",         "de": "Nach Komma",         "ru": "Чисел посля запятой"},
            "command-oid":          {"en": "Command ID",        "de": "Command ID",         "ru": "Command ID"},
            "xy-oid":               {"en": "XY ID",             "de": "XY ID",              "ru": "XY ID"},
            "level-oid":            {"en": "Level ID",          "de": "Level ID",           "ru": "Level ID"},
            "gamut":                {"en": "Gamut/Model",       "de": "Gamut/Model",        "ru": "Gamut/Model"},
            "gamut_tooltip": {
                "en": "Gamut ID (A,B,C) or Model ID (LCT001 etc.)",
                "de": "Gamut ID (A,B,C) oder Model ID (LCT001 usw.)",
                "ru": "Gamut ID (A,B,C) or Model ID (LCT001 etc.)"
            },
            "transitionTime":       {"en": "Transition Time",   "de": "Übergangszeit",      "ru": "Transition Time"},
            "transitionTime_tooltip": {
                "en": "Transition time in 1/10s",
                "de": "Übergangszeit in 1/10s",
                "ru": "Transition time in 1/10s"
            },
            "pickerBackground":     {"en": "Background Color",  "de": "Hintergrundfarbe",   "ru": "Background Color"},
            "pickerWidth":          {"en": "Picker Width",      "de": "Farbwahl Breite",    "ru": "Picker Width"},
            "pickerHeight":         {"en": "Picker Height",     "de": "Farbwahl Höhe",      "ru": "Picker Height"},
            "buttonName":           {"en": "Button Text",       "de": "Buttontext",         "ru": "Button Text"},
            "closeButton":          {"en": "Close button",      "de": "Schließen Button",   "ru": "Close button"},
        });
    }

    vis.binds.colorpicker = {
		version: "0.2.0",
		showVersion: function () {
			if (vis.binds.colorpicker.version) {
				console.log('Version vis-colorpicker: ' + vis.binds.colorpicker.version);
				vis.binds.colorpicker.version = null;
			}
		},
        /*jscolor: function (el) {
            var myPicker = new jscolor.color(document.getElementById(jQuery(el).parent().attr('id')+"_jscolor"), {})

        },*/
        rgb2hex: function (r,g,b) {
            return '#' + ('0' + r.toString(16)).slice(-2) + ('0' + g.toString(16)).slice(-2) + ('0' + b.toString(16)).slice(-2);
        },
        hex2rgb: function (hex) {
            var r = parseInt(hex.substr(1, 2), 16);
            var g = parseInt(hex.substr(3, 2), 16);
            var b = parseInt(hex.substr(5, 2), 16);
            return {r: r, g: g, b: b};
        },
        farbtastic: function (el, r_id, g_id, b_id, factor, decimal) {
            var $this = $(el);
            $this.hide();

            r_id = r_id || 'nothing_selected';
            g_id = g_id || 'nothing_selected';
            b_id = b_id || 'nothing_selected';
			decimal = parseInt(decimal || 0, 10) || 0;
			factor  = parseFloat(factor) || 255;

            var ft = $.farbtastic($this.prev(), function () {
                var color = vis.binds.colorpicker.hex2rgb(this.color);
                var r = (parseFloat(color.r) / factor).toFixed(decimal);
                var g = (parseFloat(color.g) / factor).toFixed(decimal);
                var b = (parseFloat(color.b) / factor).toFixed(decimal);
                if (!isNaN(r) && !isNaN(g) && !isNaN(b)) {
                    if (r_id && r_id !== 'nothing_selected') {
                        vis.states[r_id + '.val'] = r;
                        vis.setValue(r_id, r);
                    }
                    if (g_id && g_id !== 'nothing_selected'){
                        vis.states[g_id + '.val'] = g;
                        vis.setValue(g_id, g);
                    }
                    if (b_id && b_id !== 'nothing_selected') {
                        vis.states[b_id + '.val'] = b;
                        vis.setValue(b_id, b);
                    }
                }
            });

            var r = Math.round(parseFloat(vis.states[r_id + '.val'] || 0) * factor);
            var g = Math.round(parseFloat(vis.states[g_id + '.val'] || 0) * factor);
            var b = Math.round(parseFloat(vis.states[b_id + '.val'] || 0) * factor);
            ft.setColor(vis.binds.colorpicker.rgb2hex(r, g, b));

 			if (r_id !== 'nothing_selected') {
				vis.states.bind(r_id + '.val', function(e, newVal, oldVal) {
					var r = Math.round(parseFloat(newVal) * factor);
					var g = Math.round(parseFloat(vis.states[g_id + '.val'] || 0) * factor);
					var b = Math.round(parseFloat(vis.states[b_id + '.val'] || 0) * factor);
					ft.setColor(vis.binds.colorpicker.rgb2hex(r, g, b));
				});
			}
 			if (g_id !== 'nothing_selected') {
			    vis.states.bind(g_id + '.val', function(e, newVal, oldVal) {
					var r = Math.round(parseFloat(vis.states[r_id + '.val'] || 0) * factor);
					var g = Math.round(parseFloat(newVal) * factor);
					var b = Math.round(parseFloat(vis.states[b_id + '.val'] || 0) * factor);
					ft.setColor(vis.binds.colorpicker.rgb2hex(r, g, b));
				});
			}
			if (b_id !== 'nothing_selected') {
				vis.states.bind(b_id + '.val', function( e, newVal, oldVal ) {
					var r = Math.round(parseFloat(vis.states[r_id + '.val'] || 0) * factor);
					var g = Math.round(parseFloat(vis.states[g_id + '.val'] || 0) * factor);
					var b = Math.round(parseFloat(newVal) * factor);
					ft.setColor(vis.binds.colorpicker.rgb2hex(r, g, b));
				});
			}
        },
        spectrum: function (el, r_id, g_id, b_id, factor, decimal) {
            r_id = r_id || 'nothing_selected';
            g_id = g_id || 'nothing_selected';
            b_id = b_id || 'nothing_selected';
			factor  = parseFloat(factor) || 255;
			decimal = parseInt(decimal || 0, 10) || 0;
			
            var $this = $(el);

            $this.spectrum({
                preferredFormat: "rgb"
            });

            var r = Math.round(parseFloat(vis.states[r_id + '.val'] || 0) * factor);
            var g = Math.round(parseFloat(vis.states[g_id + '.val'] || 0) * factor);
            var b = Math.round(parseFloat(vis.states[b_id + '.val'] || 0) * factor);
            $this.spectrum("set", {r: r, g: g, b: b});

            vis.states.bind(r_id + '.val', function( e, newVal, oldVal ) {
                var r = Math.round(parseFloat(newVal) * factor, 10);
                var g = Math.round(parseFloat(vis.states[g_id + '.val'] || 0) * factor);
                var b = Math.round(parseFloat(vis.states[b_id + '.val'] || 0) * factor);
                $this.spectrum('set', {r: r, g: g, b: b});
            });
            vis.states.bind(g_id + '.val', function( e, newVal, oldVal ) {
                var r = Math.round(parseFloat(vis.states[r_id + '.val'] || 0) * factor);
                var g = Math.round(parseFloat(newVal) * factor, 10);
                var b = Math.round(parseFloat(vis.states[b_id + '.val'] || 0) * factor);
                $this.spectrum('set', {r:r, g:g, b:b});
            });
            vis.states.bind(b_id + '.val', function( e, newVal, oldVal ) {
                var r = Math.round(parseFloat(vis.states[r_id + '.val'] || 0) * factor);
                var g = Math.round(parseFloat(vis.states[g_id + '.val'] || 0) * factor);
                var b = Math.round(parseFloat(newVal) * factor, 10);
                $this.spectrum('set', {r: r, g: g, b: b});
            });
            $this.change(function() {
                var color = $this.spectrum('get').toRgb();
                var r = (parseFloat(color.r) / factor).toFixed(decimal);
                var g = (parseFloat(color.g) / factor).toFixed(decimal);
                var b = (parseFloat(color.b) / factor).toFixed(decimal);
                if (!isNaN(r) && !isNaN(g) && !isNaN(b)) {
                    if (r_id !== 'nothing_selected') {
                        vis.states[r_id + '.val'] = r;
                        vis.setValue(r_id, r);
                    }
                    if (g_id !== 'nothing_selected') {
                        vis.states[g_id + '.val'] = g;
                        vis.setValue(g_id, g);
                    }
                    if (b_id !== 'nothing_selected') {
                        vis.states[b_id + '.val'] = b;
                        vis.setValue(b_id, b);
                    }
                }
            });
        },
        jscolorcie: function (el, cmd_id, xy_id, level_id, pickerWidth, pickerHeight, pickerBackground, gamut, transitionTime, buttonName, closeButton) {
            cmd_id = cmd_id || 'nothing_selected';
            xy_id = xy_id || 'nothing_selected';
            level_id = level_id || 'nothing_selected';
            pickerWidth = parseInt(pickerWidth) || 100;
            pickerHeight = parseInt(pickerHeight) || 100;
            gamut = typeof gamut === 'string' ? gamut : "default";
            gamutZoom = true;
            transitionTime = parseInt(transitionTime) || 0;
            buttonName = typeof buttonName === 'string' ? buttonName : "";
            closeButton =  typeof closeButton === 'string' ? closeButton : ""

            var $this = $(el);
            $this.html(buttonName);

            var onChange = function () {
                if (cmd_id !== 'nothing_selected') {
                    var cmd = '{"transitiontime":' + transitionTime + ',"xy":"' + picker.xy[0] + ',' + picker.xy[1] + '",' + '"level":' + Math.round(picker.xy[2]*100) +'}';
                    vis.setValue(cmd_id, cmd);
                }
            };
            var picker = new jscolor($this[0], {
                valueElement: false,
                onFineChange: onChange,
                mode: 'CIE',
                gamut: gamut,
                gamutZoom: gamutZoom,
                width: pickerWidth,
                height: pickerHeight,
                closable: closeButton != "",
                closeText: closeButton,
                padding: 0,
                shadow: false,
                borderWidth: 0,
                backgroundColor: pickerBackground,
                insetColor: '#000',
            });

            if (cmd_id !== 'nothing_selected' && xy_id !== 'nothing_selected' && level_id !== 'nothing_selected') {
                var xy = (vis.states[xy_id + '.val'] || "0.5,0.5").split(',');
                var level = vis.states[level_id + '.val'] || 0;
                if (xy.length == 2) {
                    picker.fromXY(parseFloat(xy[0]),parseFloat(xy[1]),parseInt(level)/100);
                }

                vis.states.bind(xy_id + '.val', function( e, newVal, oldVal ) {
                    var xy = (vis.states[xy_id + '.val'] || "0.5,0.5").split(',');
                    var level = vis.states[level_id + '.val'] || 0;
                    if (xy.length == 2) {
                        picker.fromXY(parseFloat(xy[0]),parseFloat(xy[1]),parseInt(level)/100);
                    }
                });

                vis.states.bind(level_id + '.val', function( e, newVal, oldVal ) {
                    var xy = (vis.states[xy_id + '.val'] || "0.5,0.5").split(',');
                    var level = vis.states[level_id + '.val'] || 0;
                    if (xy.length == 2) {
                        picker.fromXY(parseFloat(xy[0]),parseFloat(xy[1]),parseInt(level)/100);
                    }
                });
            }
        },

        changedHUE: function (widgetID, view, newId, fields) {
            var cmd = vis.objects[newId];
            var changed = [];
            // If it is real object and state
            if (cmd && cmd.common && cmd.type == 'state') {
                var light = vis.objects[newId.split('.', 4).join('.')];
                var xy = vis.objects[newId.split('.', 4).join('.')+'.xy'];
                var level = vis.objects[newId.split('.', 4).join('.')+'.level'];

                if (xy && xy.type === 'state' && !vis.views[view].widgets[widgetID].data["xy-oid"]) {
                    changed.push('xy-oid');
                    vis.views[view].widgets[widgetID].data["xy-oid"] = newId.split('.', 4).join('.')+'.xy';
                    vis.widgets[widgetID].data["xy-oid"] = newId.split('.', 4).join('.')+'.xy';
                }
                if (level && level.type === 'state' && !vis.views[view].widgets[widgetID].data["level-oid"]) {
                    changed.push('level-oid');
                    vis.views[view].widgets[widgetID].data["level-oid"] = newId.split('.', 4).join('.')+'.level';
                    vis.widgets[widgetID].data["level-oid"] = newId.split('.', 4).join('.')+'.level';
                }
                if (light.native.modelid !== undefined && !vis.views[view].widgets[widgetID].data.gamut) {
                    changed.push('gamut');
                    vis.views[view].widgets[widgetID].data.gamut = light.native.modelid;
                    vis.widgets[widgetID].data.gamut = light.native.modelid;
                }
            }
            return changed;
        }
    };
	vis.binds.colorpicker.showVersion();
</script>

<script id="tplRGBSpectrum"
        type="text/ejs"
        class="vis-tpl"
        data-vis-prev='<img src="widgets/colorpicker/img/Prev_tplRGBSpectrum.png"></img>'
        data-vis-set="colorpicker"
        data-vis-type="ctrl,color"
        data-vis-name="RGB spectrum"
        data-vis-attrs="red-oid/id;green-oid/id;blue-oid/id;divisor[255];decimal[0]/slider,0,5,1">
    <div class="vis-widget <%== this.data.attr('class') %>" style="" id="<%= this.data.attr('wid') %>">
        <div class="vis-widget-body">
            <input id="<%= this.data.attr('wid') %>_spectrum" <%= (el) -> vis.binds.colorpicker.spectrum(el, data.attr('red-oid'), data.attr('green-oid'), data.attr('blue-oid'), data.attr('divisor'), data.attr('decimal')) %>>
        </div>
    </div>
</script>


<script id="tplRGBFarbtastic"
        class="vis-tpl" 
        type="text/ejs"
        data-vis-prev='<img src="widgets/colorpicker/img/Prev_tplRGBFarbtastic.png"></img>'
        data-vis-set="colorpicker"
        data-vis-name="ctrl - rgb farbtastic" 
        data-vis-attrs="red-oid/id;green-oid/id;blue-oid/id;divisor[255];decimal[0]/slider,0,5,1">
    <div class="vis-widget <%== this.data.attr('class') %>" style="width: 196px; height: 196px;" id="<%= this.data.attr('wid') %>">
        <div class="vis-widget-body">
            <div id="<%= this.data.attr('wid') %>_farbtastic"></div>
            <input id="<%= this.data.attr('wid') %>_farbtastic_input" value="" <%= (el) -> vis.binds.colorpicker.farbtastic(el, data.attr('red-oid'), data.attr('green-oid'), data.attr('blue-oid'), data.attr('divisor'), data.attr('decimal')) %>>
        </div>
    </div>
</script>

<script id="tplHUEjscolor"
        type="text/ejs"
        class="vis-tpl"
        data-vis-prev='<img src="widgets/colorpicker/img/Prev_tplHUEjscolor.png"></img>'
        data-vis-set="colorpicker"
        data-vis-type="ctrl,color"
        data-vis-name="Philips HUE"
        data-vis-attrs="command-oid/id/changedHUE;xy-oid/id;level-oid/id;gamut[default];transitionTime[400]/number,0,20000,1;pickerWidth[100]/number,0,500,1;pickerHeight[100]/number,0,500,1;pickerBackground/color;buttonName[HUE];closeButton[close]">
    <div class="vis-widget <%== this.data.attr('class') %>" style="width:100px;height:100px;" id="<%= this.data.attr('wid') %>">
        <div class="vis-widget-body" style="display:table;">
            <div class="ui-button ui-state-default ui-corner-all" style="width:100%;height:100%;display:table-cell;" id="<%= this.data.attr('wid') %>_jscolorcie" value="" <%= (el) -> vis.binds.colorpicker.jscolorcie(el, data.attr('command-oid'), data.attr('xy-oid'), data.attr('level-oid'), data.attr('pickerWidth'), data.attr('pickerHeight'), data.attr('pickerBackground'), data.attr('gamut'), data.attr('transitionTime'), data.attr('buttonName'), data.attr('closeButton')) %> ></div>
        </div>
    </div>
</script>


        <!--

<script id="tplJscolor" 
		type="text/ejs" 
		class="vis-tpl" 
		data-vis-set="colorpicker" 
		data-vis-name="jscolor" 
		data-vis-attrs="hue-id/id;sat-oid/id;bri-oid/id">
    <div class="vis-widget <%== this.data.attr('class') %>" style="width: 200px; height: 130px; border: 1px solid #000; background: #fff;" id="<%= this.data.attr('wid') %>">
        <div class="vis-widget-body">
            <input id="<%= this.data.attr('wid') %>_jscolor">
            <div class="popup-helper" <%= (el) -> vis.binds.colorpicker.jscolor(el) %>></div>
        </div>
    </div>
</script>





<script type="text/ejs" id="tplDmxFarbtastic" class="vis-tpl" data-vis-set="colorpicker" data-vis-name="dmx_ctrl - farbtastic (unfertig)" data-vis-attrs="program_id;red_channel;green_channel;blue_channel">
    <div class="vis-widget <%== this.data.attr('class') %>" style="width: 195px; height: 195px;" id="<%= this.data.attr('wid') %>">
        <div class="vis-widget-body">
            <div id="<%= this.data.attr('wid') %>_farbtastic"></div>
            <input id="<%= this.data.attr('wid') %>_farbtastic_input" value=""  <%= (el) -> vis.binds.colorpicker.farbtastic(el) %>>
        </div>
    </div>
</script>

<script type="text/ejs" id="tplFarbtasticDialog" class="vis-tpl" data-vis-set="colorpicker" data-vis-name="hue_ctrl - farbtastic jqui Dialog (unfertig)" data-vis-attrs="lamp_id;program_id;hue_id;sat_id;bri_id">
    <div class="vis-widget <%== this.data.attr('class') %>" style="width: 200px; height: 130px; border: 1px solid #000; background: #fff;" id="<%= this.data.attr('wid') %>">
        <div class="vis-widget-body">
            <div id="<%= this.data.attr('wid') %>_farbtastic"></div>
            <input id="<%= this.data.attr('wid') %>_farbtastic_input" value="" <%= (el) -> vis.binds.colorpicker.farbtastic(el) %>>
        </div>
    </div>
</script>

<script type="text/ejs" id="tplDmxFarbtasticDialog" class="vis-tpl" data-vis-set="colorpicker" data-vis-name="dmx_ctrl - farbtastic jqui Dialog (unfertig)" data-vis-attrs="program_id;red_channel;green_channel;blue_channel">
    <div class="vis-widget <%== this.data.attr('class') %>" style="width: 195px; height: 195px;" id="<%= this.data.attr('wid') %>">
        <div class="vis-widget-body">
            <div id="<%= this.data.attr('wid') %>_farbtastic"></div>
            <input id="<%= this.data.attr('wid') %>_farbtastic_input" value=""  <%= (el) -> vis.binds.colorpicker.farbtastic(el) %>>
        </div>
    </div>
</script>


<script type="text/ejs" id="tplSpectrum" class="vis-tpl" data-vis-set="colorpicker" data-vis-name="hue_ctrl - spectrum (unfertig)" data-vis-attrs="lamp_id;program_id;hue_id;sat_id;bri_id">
    <div class="vis-widget <%== this.data.attr('class') %>" style="" id="<%= this.data.attr('wid') %>">
        <div class="vis-widget-body">
            <input id="<%= this.data.attr('wid') %>_spectrum" value="" <%= (el) -> vis.binds.colorpicker.spectrum(el) %>>
        </div>
    </div>
</script>


<script type="text/ejs" id="tplDmxSpectrum" class="vis-tpl" data-vis-set="colorpicker" data-vis-name="dmx_ctrl - spectrum (unfertig)" data-vis-attrs="program_id;red_channel;green_channel;blue_channel">
    <div class="vis-widget <%== this.data.attr('class') %>" style="" id="<%= this.data.attr('wid') %>">
        <div class="vis-widget-body">
            <input id="<%= this.data.attr('wid') %>_spectrum" value="" <%= (el) -> vis.binds.colorpicker.spectrum(el) %>>
        </div>
    </div